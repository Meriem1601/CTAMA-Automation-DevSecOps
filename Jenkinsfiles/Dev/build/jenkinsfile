pipeline {
    agent {
        label 'EC2-Agent'
    }

    options {
        timeout(time: 60, unit: 'MINUTES')
        disableConcurrentBuilds()
        ansiColor('xterm')
    }

    environment {
        NODE_ENV = 'development'
        ARTIFACT_NAME = "backend-artifact-${BUILD_NUMBER}.tar.gz"
        ARTIFACT_PATH = "${WORKSPACE}/artifacts"
        TRIVY_REPORTS_DIR = "${WORKSPACE}/trivy-reports"
        SLACK_CHANNEL = '#were-building-a-cutting-edge-devsecops-solution'
    }

    stages {
        stage('Welcome') {
            steps {
                echo '''
                â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—
                â•‘ ğŸš€ Backend JavaScript Application CI Pipeline    â•‘
                â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
                '''
                echo 'Initiating Continuous Integration for backend application.'
                echo 'Performing comprehensive code quality, security, and artifact creation checks.'
            }
        }

        stage('Build Artifact') {
            parallel {
                stage('Install Dependencies') {
                    steps {
                        sh 'npm install --silent'
                    }
                }

                stage('Create Artifact') {
                    steps {
                        script {
                            sh "mkdir -p ${ARTIFACT_PATH}"
                            
                            sh """
                                tar -czvf ${ARTIFACT_PATH}/${ARTIFACT_NAME} \
                                --exclude='.git' \
                                --exclude='node_modules' \
                                --exclude='artifacts' \
                                --exclude='Jenkinsfiles' \
                                --exclude='.gitignore' \
                                --exclude='push_to_ghcr.sh' \
                                --exclude='run-sonar.sh' \
                                --exclude='*.log' \
                                --exclude='*.md' \
                                --exclude='dockerfile' \
                                --exclude='App-Production' \
                                . 
                            """
                            
                            sh "ls -lh ${ARTIFACT_PATH}"
                        }
                    }
                    post {
                        success {
                            archiveArtifacts artifacts: "artifacts/${ARTIFACT_NAME}", 
                                             fingerprint: true, 
                                             onlyIfSuccessful: true
                        }
                    }
                }
            }
        }

        stage('SonarQube - SAST Analysis') {
            steps {
                script {
                    try {
                        withCredentials([string(credentialsId: 'sonarqube-token', variable: 'SONAR_TOKEN')]) {
                            sh 'chmod +x Sonar_codeQuaity.sh'
                            sh './Sonar_codeQuaity.sh'
                        }
                        echo "âœ… SonarQube analysis completed successfully."
                    } catch (Exception e) {
                        echo "âŒ SonarQube analysis encountered an issue: ${e.message}"
                        error "SonarQube analysis failed: ${e.message}"
                    }
                }
            }
        }

        stage('OWASP Dependency-Check') {
            steps {
                script {
                    try {
                        dependencyCheck(
                            additionalArguments: '''
                                -o ./dependency-check-report 
                                -s ./ 
                                -f 'ALL' 
                                --prettyPrint 
                                --log dependency-check.log
                                --noupdate
                            ''',
                            odcInstallation: 'OWASP Dependency-Check Vulnerabilities'
                        )
                        
                        dependencyCheckPublisher(
                            pattern: 'dependency-check-report/dependency-check-report.xml'
                        )
                        
                        echo "âœ… Dependency Check completed successfully."
                    } catch (Exception e) {
                        echo "âŒ Dependency Check encountered an issue: ${e.message}"
                    }
                }
            }
            post {
                always {
                    publishHTML(
                        target: [
                            reportName: 'Dependency Check Report',
                            reportDir: 'dependency-check-report',
                            reportFiles: 'dependency-check-report.html',
                            keepAll: true,
                            alwaysLinkToLastBuild: true,
                            allowMissing: false
                        ]
                    )
                }
            }
        }

        stage('Docker Build and Push to GHCR') {
            steps {
                script {
                    try {
                        echo '''
                        â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—
                        â•‘ ğŸ³ Building and Pushing Docker Image to GHCR    â•‘
                        â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
                        '''
                        
                        withCredentials([string(credentialsId: 'github-token', variable: 'GITHUB_TOKEN')]) {
                            sh 'chmod +x ./ghcr_deploy.sh'
                            sh './ghcr_deploy.sh'
                        }
                        echo "âœ… Docker image successfully built and pushed to GHCR."
                    } catch (Exception e) {
                        error "âŒ Failed to build or push Docker image: ${e.message}"
                    }
                }
            }
        }

        stage('Trivy Security Scan') {
            steps {
                script {
                    try {
                        echo '''
                        â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—
                        â•‘ ğŸ”’ Running Trivy Security Scan on Docker Image   â•‘
                        â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
                        '''
                        
                        sh 'chmod +x ./trivy-scan.sh'
                        sh './trivy-scan.sh'
                        
                        echo "âœ… Trivy security scan completed successfully."
                    } catch (Exception e) {
                        echo "âŒ Trivy security scan encountered an issue: ${e.message}"
                        error "Trivy security scan failed: ${e.message}"
                    }
                }
            }
        }
    }

    post {
        success {
            script {
                echo '''
                â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—
                â•‘ âœ¨ CI Pipeline Completed Successfully            â•‘
                â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
                '''
                echo "The backend application has passed all stages successfully."
                echo "Artifact is ready for deployment, and security checks have been completed."
                
                slackSend(
                    channel: SLACK_CHANNEL,
                    color: 'good',
                    message: """
ğŸ‰ *CI Pipeline Successfully Completed!* ğŸš€

*Build Details:*
- ğŸ“¦ *Artifact Created:* \`${ARTIFACT_NAME}\`
- ğŸ” *SonarQube Analysis:* Passed
- ğŸ›¡ï¸ *OWASP Dependency Check:* Completed
- ğŸ³ *Docker Image:* Built and Pushed to GHCR
- ğŸ”’ *Trivy Security Scan:* Passed

*Build Information:*
- â±ï¸ *Duration:* ${currentBuild.durationString}
- ğŸ‘¤ *Triggered By:* ${env.BUILD_USER ?: 'Automated Trigger'}
- ğŸ”¢ *Build Number:* #${env.BUILD_NUMBER}

*Quick Links:*
- ğŸ”— Jenkins Build: ${env.BUILD_URL}
- ğŸ“Š SonarQube Report: Available in Jenkins
- ğŸ“ Dependency Check Report: Available in Jenkins
- ğŸ“‹ Trivy Scan Report: Available in Jenkins

*Next Steps:* 
âœ… Artifact is ready for deployment pipeline
"""
                )
            }
        }
        
        failure {
            script {
                echo '''
                â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—
                â•‘ âŒ CI Pipeline Encountered Issues                â•‘
                â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
                '''
                echo "Please review the pipeline logs for detailed error information."
                
                slackSend(
                    channel: SLACK_CHANNEL,
                    color: 'danger',
                    message: """
âŒ *CI Pipeline Failed!* ğŸ’¥

*Error Summary:*
- ğŸš¨ Build process encountered critical issues
- ğŸ” Immediate investigation required

*Build Details:*
- *Failed Stage:* ${currentBuild.currentResult}
- *Build Number:* #${env.BUILD_NUMBER}
- â±ï¸ *Duration:* ${currentBuild.durationString}
- ğŸ‘¤ *Triggered By:* ${env.BUILD_USER ?: 'Automated Trigger'}

*Quick Access:*
- ğŸ”— Failed Build: ${env.BUILD_URL}

*Recommended Actions:*
1. ğŸ•µï¸ Check Jenkins console output
2. ğŸ” Review stage logs
3. ğŸ“ Check for dependency or security issues

*Need Help?* ğŸ“ Contact the DevOps Team
"""
                )
            }
        }
        
        unstable {
            script {
                slackSend(
                    channel: SLACK_CHANNEL,
                    color: 'warning',
                    message: """
âš ï¸ *CI Pipeline Partially Successful* ğŸŸ¨

*Status:* ğŸ”¶ Unstable Build Detected

*Build Information:*
- *Build Number:* #${env.BUILD_NUMBER}
- â±ï¸ *Duration:* ${currentBuild.durationString}
- ğŸ‘¤ *Triggered By:* ${env.BUILD_USER ?: 'Automated Trigger'}

*Potential Issues:*
- ğŸ§© Some stages completed with warnings
- ğŸ”¬ Quality gates may need review
- ğŸ›¡ï¸ Security scans may have found non-critical issues

*Quick Access:*
- ğŸ”— Build Details: ${env.BUILD_URL}

*Recommended Actions:*
1. ğŸ” Review warning messages
2. ğŸ“Š Check quality reports
3. ğŸ”’ Verify security scan results

*Need Assistance?* ğŸ’¬ Contact the DevOps Team
"""
                )
            }
        }
        
        always {
            cleanWs()
        }
    }
}
