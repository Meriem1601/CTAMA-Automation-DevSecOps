pipeline {
    agent {
        label 'EC2-Agent'
    }
    
    options {
        timeout(time: 60, unit: 'MINUTES')
        disableConcurrentBuilds()
        ansiColor('xterm')
    }
    
    environment {
        NODE_ENV = 'development'
        ARTIFACT_NAME = "backend-artifact-${BUILD_NUMBER}.tar.gz"
        ARTIFACT_PATH = "${WORKSPACE}/artifacts"
    }
    
    stages {
        stage('Welcome') {
            steps {
                echo '''
                ╔═══════════════════════════════════════════════════╗
                ║ 🚀 Backend JavaScript Application CI Pipeline    ║
                ╚═══════════════════════════════════════════════════╝
                '''
                echo 'Initiating Continuous Integration for backend application.'
                echo 'Performing comprehensive code quality, security, and artifact creation checks.'
            }
        }
        
        stage('Parallel Init Tasks') {
            parallel {
                stage('Install Dependencies') {
                    steps {
                        sh 'npm install --silent'
                    }
                }
                
                stage('Build Artifact') {
                    steps {
                        script {
                            //First we Create our Artifact Directory 
                            sh "mkdir -p ${ARTIFACT_PATH}"
                            
                            // Here we are Creating artifact with comprehensive exclusions
                            sh """
                                tar -czvf ${ARTIFACT_PATH}/${ARTIFACT_NAME} \
                                --exclude='.git' \
                                --exclude='node_modules' \
                                --exclude='artifacts' \
                                --exclude='Jenkinsfiles' \
                                --exclude='.gitignore' \
                                --exclude='push_to_ghcr.sh' \
                                --exclude='run-sonar.sh' \
                                --exclude='*.log' \
                                --exclude='*.md' \
                                --exclude='dockerfile' \
                                --exclude='App-Production' \
                                .
                            """
                            
                            // Here we are Verifying the artifact creation
                            sh "ls -lh ${ARTIFACT_PATH}"
                        }
                    }
                    post {
                        success {
                            archiveArtifacts artifacts: "artifacts/${ARTIFACT_NAME}", 
                                             fingerprint: true, 
                                             onlyIfSuccessful: true
                        }
                    }
                }
            }
        }
        
        stage('SonarQube - SAST Analysis') {
            steps {

                // Create output directory
                sh 'mkdir -p dependency-check-reports'
                
                // Run Dependency Check
                dependencyCheck(
                    additionalArguments: '''
                        -s ./ 
                        -f XML 
                        -f HTML 
                        -o dependency-check-reports 
                        --prettyPrint
                        --failOnCVSS 60
                    ''',
                    odcInstallation: 'OWASP Dependency-Check Vulnerabilities'
                )
                
                // Publish the report without any failure conditions
                dependencyCheckPublisher(
                    pattern: 'dependency-check-reports/dependency-check-report.xml'
                )

                script {
                    try {
                        withCredentials([string(credentialsId: 'sonarqube-token', variable: 'SONAR_TOKEN')]) {
                          sh './run-sonar.sh'
                        }
                        echo "✅ SonarQube analysis completed successfully."
                    } catch (Exception e) {
                        echo "❌ SonarQube analysis encountered an issue: ${e.message}"
                    }
                }
            }
        }
        
        stage('OWASP Dependency-Check') {
            steps {
                script {
                    try {
                        dependencyCheck(
                            additionalArguments: '''
                                -o ./dependency-check-report 
                                -s ./ 
                                -f 'ALL' 
                                --prettyPrint 
                                --log dependency-check.log
                            ''',
                            odcInstallation: 'OWASP Dependency-Check Vulnerabilities'
                        )
                        
                        dependencyCheckPublisher(
                            pattern: 'dependency-check-report/dependency-check-report.xml'
                        )
                        
                        echo "✅ Dependency Check completed successfully."
                    } catch (Exception e) {
                        echo "❌ Dependency Check encountered an issue: ${e.message}"
                    }
                }
            }
            post {
                always {
                    publishHTML(
                        target: [
                            reportName: 'Dependency Check Report',
                            reportDir: 'dependency-check-report',
                            reportFiles: 'dependency-check-report.html',
                            keepAll: true,
                            alwaysLinkToLastBuild: true,
                            allowMissing: false  // Consider `true` if report generation might fail.
                        ]
                    )
                }

            }
        }
    }
    
    post {
        success {
            echo '''
            ╔═══════════════════════════════════════════════════╗
            ║ ✨ CI Pipeline Completed Successfully            ║
            ╚═══════════════════════════════════════════════════╝
            '''
            echo "Artifact created: ${ARTIFACT_NAME}"
            echo "Ready for further deployment and testing."
        }
        
        failure {

            echo 'The CI pipeline has encountered an issue. Please check the logs for more information.'
        }
        always {
            // Archive the dependency check reports
            archiveArtifacts artifacts: 'dependency-check-reports/*', allowEmptyArchive: true
        }
    }
}

            echo '''
            ╔═══════════════════════════════════════════════════╗
            ║ ❌ CI Pipeline Encountered Issues               ║
            ╚═══════════════════════════════════════════════════╝

