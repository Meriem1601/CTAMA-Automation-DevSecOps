pipeline {
    agent {
        label 'EC2-Agent'
    }

    environment {
        KUBECONFIG = '/root/.kube/config'
        MYSQL_DEPLOYMENT_DIR = 'mysql-deployment'
        BACKEND_DEPLOYMENT_DIR = 'backend-deployment'
        SLACK_CHANNEL = '#were-building-a-cutting-edge-devsecops-solution'
    }

    stages {
        stage('ğŸš€ Validate Kubernetes Environment') {
            steps {
                script {
                    sh '''
                        echo "ğŸŒ Checking Kubernetes cluster readiness..."
                        kubectl cluster-info
                        kubectl get nodes
                    '''
                }
            }
        }

        stage('ğŸ›¡ï¸ Verify Kyverno Security Policies') {
            steps {
                script {
                    try {
                        sh '''
                            echo "ğŸ” Checking Kyverno namespace and policies..."
                            kubectl get ns kyverno
                            kubectl get pods -n kyverno -o wide | grep Running
                            kubectl get clusterpolicies
                            kubectl get policies --all-namespaces
                        '''
                    } catch (Exception e) {
                        error "âŒ Kyverno security validation failed: ${e.getMessage()}"
                    }
                }
            }
        }

        stage('ğŸ’¾ Deploy MySQL Database') {
            steps {
                script {
                    sh '''
                        echo "ğŸ—„ï¸ Deploying MySQL components..."
                        for resource in ${MYSQL_DEPLOYMENT_DIR}/*.yaml; do
                            if [ -f "$resource" ]; then
                                echo "ğŸ“¤ Applying $resource to devsecops-prod namespace"
                                kubectl apply -f "$resource" -n devsecops-prod
                            else
                                echo "â— No MySQL deployment files found"
                                exit 1
                            fi
                        done
                        
                        # Wait for MySQL StatefulSet to be ready
                    '''
                }
            }
        }

        stage('ğŸ” Verify MySQL Deployment') {
            steps {
                script {
                    sh '''
                        echo "âœ… Verifying MySQL deployment in devsecops-prod namespace..."
                        kubectl get statefulsets -n devsecops-prod
                        kubectl get services -n devsecops-prod | grep mysql
                        kubectl get pods -n devsecops-prod | grep mysql
                    '''
                }
            }
        }

        stage('ğŸš¢ Deploy Backend Application') {
            steps {
                script {
                    sh '''
                        echo "ğŸ”§ Deploying Backend components..."
                        for resource in ${BACKEND_DEPLOYMENT_DIR}/*.yaml; do
                            # Skip deployment.yaml to control rollout separately
                            if [[ "$resource" == *"deployment.yaml" ]]; then
                                echo "â© Skipping $resource"
                                continue
                            fi
                            
                            echo "ğŸ“¡ Applying $resource to devsecops-prod namespace"
                            kubectl apply -f "$resource" -n devsecops-prod
                        done
                    '''
                }
            }
        }

        stage('ğŸ•¹ï¸ Verify Backend Application') {
            steps {
                script {
                    sh '''
                        echo "ğŸ”¬ Verifying backend app deployment in devsecops-prod namespace..."
                        kubectl get pods -n devsecops-prod | grep backend-app
                        kubectl get deployments -n devsecops-prod | grep backend-app
                    '''
                }
            }
        }
    }

    post {
        success {
            script {
                slackSend(
                    channel: SLACK_CHANNEL,
                    color: 'good',
                    tokenCredentialId: 'slack-webhook',
                    message: """
ğŸ‰ *Deployment Successfully Completed!* ğŸš€

*Deployment Details:*
- ğŸ’¾ *MySQL Database*: Deployed and Verified
- ğŸš¢ *Backend Application*: Rolled Out Successfully
- ğŸŒ *Namespace*: `devsecops-prod`

*Cluster Health:* ğŸ’š All Systems Operational
*Deployment Time:* â±ï¸ ${currentBuild.durationString}

*Deployed By:* ğŸ‘¤ ${env.BUILD_USER}
*Build Number:* #${env.BUILD_NUMBER}

*Quick Links:*
- Jenkins Build: ${env.BUILD_URL}
- Kubernetes Namespace: devsecops-prod

*Next Steps:* ğŸ” Perform final application testing
"""
                )
            }
        }
        
        failure {
            script {
                slackSend(
                    channel: SLACK_CHANNEL,
                    color: 'danger',
                    tokenCredentialId: 'slack-webhook',
                    message: """
âŒ *Deployment Failed!* ğŸ’¥

*Error Summary:*
- ğŸš¨ Deployment process encountered critical issues
- ğŸ” Immediate investigation required

*Failure Details:*
- *Stage:* ${currentStage.name}
- *Build Number:* #${env.BUILD_NUMBER}

*Recommended Actions:*
1. ğŸ•µï¸ Check Jenkins logs
2. ğŸ”§ Review Kubernetes configurations
3. ï¿½logs Inspect detailed error messages

*Need Help?* ğŸ“ Contact DevOps Support Team
"""
                )
            }
        }
        
        unstable {
            script {
                slackSend(
                    channel: SLACK_CHANNEL,
                    color: 'warning',
                    tokenCredentialId: 'slack-webhook',
                    message: """
âš ï¸ *Deployment Partially Successful* ğŸŸ¨

*Status:* ğŸ”¶ Unstable Deployment Detected

*Potential Issues:*
- ğŸ§© Some components may not be fully initialized
- ğŸ”¬ Partial deployment success

*Deployment Insights:*
- *Build Number:* #${env.BUILD_NUMBER}
- *Namespace:* devsecops-prod

*Recommended Next Steps:*
1. ğŸ” Conduct manual verification
2. ğŸ§ Review component statuses
3. ğŸ”„ Consider re-running deployment

*Need Assistance?* ğŸ’¬ Reach out to DevOps team
"""
                )
            }
        }
        
        always {
            cleanWs()
        }
    }
}
